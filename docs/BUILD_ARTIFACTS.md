# Build Artifacts Documentation

Comprehensive guide to Solidity compilation artifacts generated by `scripts/compile_all.py`.

## Quick Start

```bash
# Compile all contracts
./scripts/compile.sh

# Compile specific contract
python3 scripts/compile_all.py --contract FutarchyArbExecutorV5

# Compile with SMT verification
python3 scripts/compile_all.py --contract SafetyModule --smt
```

## Artifacts Directory Structure

```
artifacts/
├── abi/                    # Contract ABIs (JSON)
│   ├── *.json              # Full ABI definitions
│   └── *.methods.txt       # Method signatures (4-byte selectors)
├── bytecode/               # Compiled bytecode
│   ├── *.bin               # Deployment bytecode (raw hex)
│   ├── *.hex               # Deployment bytecode (0x prefixed)
│   └── *.runtime.bin       # Runtime bytecode
├── asm/                    # Assembly output
│   └── *.asm               # EVM assembly code
├── opcodes/                # EVM opcodes
│   ├── *.opcodes           # Raw opcode listing
│   └── *.readable.txt      # Human-readable with addresses
├── storage/                # Storage layouts
│   └── *.storage.json      # Variable storage slots
├── ast/                    # Abstract Syntax Trees
│   └── *.ast.json          # Compiler AST output
├── smt/                    # SMT verification (when --smt used)
│   └── *.smt2              # SMT-LIB2 formal verification
└── compilation_summary.json # Compilation metadata
```

## Artifact Types

### 1. ABI (Application Binary Interface)

**File**: `artifacts/abi/<ContractName>.json`

Contract interface definition in JSON format. Contains:

- Function signatures
- Event definitions
- Constructor parameters
- State variable getters

**Usage**:

```python
from web3 import Web3
import json

# Load ABI
with open("artifacts/abi/FutarchyArbExecutorV5.json") as f:
    abi = json.load(f)

# Create contract instance
contract = web3.eth.contract(address=contract_address, abi=abi)
```

**Method Identifiers**: `artifacts/abi/<ContractName>.methods.txt`

Human-readable function selectors:

```
buyConditional(uint256,uint256): 0x1a2b3c4d
sellConditional(uint256,uint256): 0x5e6f7a8b
```

### 2. Bytecode

**Deployment Code**: `artifacts/bytecode/<ContractName>.bin`

Complete bytecode including:

- Constructor logic
- Constructor arguments placeholder
- Runtime code

**Runtime Code**: `artifacts/bytecode/<ContractName>.runtime.bin`

Code deployed on-chain after construction. Used for:

- Bytecode verification on block explorers
- Contract size analysis (24KB limit)

**Size Check**:

```bash
# Check if contract exceeds 24KB limit
wc -c artifacts/bytecode/InstitutionalSolverCore.runtime.bin
```

### 3. Assembly (ASM)

**File**: `artifacts/asm/<ContractName>.asm`

EVM assembly code with:

- Named labels
- Push instructions
- Jump destinations
- Data sections

**Example**:

```asm
PUSH1 0x80
PUSH1 0x40
MSTORE
CALLVALUE
DUP1
ISZERO
PUSH2 0x0010
JUMPI
```

**Use Cases**:

- Gas optimization analysis
- Understanding compiler transformations
- Debugging low-level issues

### 4. Opcodes

**Raw Opcodes**: `artifacts/opcodes/<ContractName>.opcodes`

Space-separated opcode sequence:

```
PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x0010 JUMPI
```

**Readable Opcodes**: `artifacts/opcodes/<ContractName>.readable.txt`

Human-readable format with addresses:

```
0000: PUSH1
      0x80
0002: PUSH1
      0x40
0004: MSTORE
0005: CALLVALUE
0006: DUP1
```

**Use Cases**:

- Manual gas calculations
- Opcode-level debugging
- Security audits (checking for SELFDESTRUCT, DELEGATECALL)

### 5. Storage Layout

**File**: `artifacts/storage/<ContractName>.storage.json`

Mapping of state variables to storage slots:

```json
{
  "storage": [
    {
      "astId": 123,
      "contract": "FutarchyArbExecutorV5",
      "label": "owner",
      "offset": 0,
      "slot": "0",
      "type": "t_address"
    },
    {
      "astId": 456,
      "contract": "FutarchyArbExecutorV5",
      "label": "nonce",
      "offset": 0,
      "slot": "1",
      "type": "t_uint256"
    }
  ]
}
```

**Use Cases**:

- Storage collision detection
- Upgrade compatibility (for proxies)
- Direct storage reads via `eth_getStorageAt`

**Reading Storage**:

```python
# Read owner from slot 0
owner_slot = web3.eth.get_storage_at(contract_address, 0)
owner = web3.to_checksum_address(owner_slot[-20:].hex())
```

### 6. AST (Abstract Syntax Tree)

**File**: `artifacts/ast/<ContractName>.ast.json`

Compiler's internal representation:

- Contract structure
- Function definitions
- Type information
- Source mappings

**Use Cases**:

- Static analysis tools
- Code generation
- Documentation generation
- Linting tools

### 7. SMT (Formal Verification)

**File**: `artifacts/smt/<ContractName>.smt2` (when `--smt` flag used)

SMT-LIB2 format for formal verification:

```smt2
(assert (forall ((amount uint256))
  (=> (>= (balance sender) amount)
      (>= (balance sender after transfer) 0))))
```

**SMT Checker Targets**:

- `underflow` - Integer underflow
- `overflow` - Integer overflow
- `divByZero` - Division by zero
- `assert` - Failed assertions
- `balance` - Ether balance invariants

**Running SMT Checker**:

```bash
python3 scripts/compile_all.py --contract SafetyModule --smt
```

**Interpreting Results**:

- ✓ No warnings: Formal verification passed
- ⚠️ Warnings: Potential issues found (false positives possible)
- ✗ Errors: Verification failed (likely bugs)

## Compilation Options

### Optimizer Settings

**Enabled by Default**: 200 runs

```bash
# Disable optimizer (larger bytecode, cheaper deployment)
python3 scripts/compile_all.py --no-optimize

# Use Via-IR (better optimization, required for large contracts)
python3 scripts/compile_all.py --via-ir  # Default
python3 scripts/compile_all.py --no-via-ir  # Legacy optimizer
```

**Optimizer Trade-offs**:

- More runs → Higher deployment cost, lower runtime cost
- Fewer runs → Lower deployment cost, higher runtime cost

**For Futarchy Contracts**: 200 runs balances deployment and execution costs.

### EVM Version

**Default**: `osaka` (EIP-7702 support)

**Available Versions**:

- `paris` - Pre-merge (no PUSH0)
- `shanghai` - Post-merge (with PUSH0)
- `osaka` - Pectra fork (EIP-7702)

```bash
# Override in script if needed
python3 scripts/compile_all.py --evm-version shanghai
```

## Integration with Deployment Scripts

### Old Pattern (Inline Compilation)

```python
# deploy_executor_v5.py (before)
solc_cmd = ["solc", "--optimize", contract_path]
result = subprocess.run(solc_cmd, capture_output=True)
# Parse bytecode from stdout
```

### New Pattern (Pre-compiled Artifacts)

```python
# deploy_executor_v5.py (updated)
import json
from pathlib import Path

# Load pre-compiled artifacts
abi_path = Path("artifacts/abi/FutarchyArbExecutorV5.json")
bytecode_path = Path("artifacts/bytecode/FutarchyArbExecutorV5.hex")

with open(abi_path) as f:
    abi = json.load(f)

with open(bytecode_path) as f:
    bytecode = f.read().strip()

# Deploy
contract = web3.eth.contract(abi=abi, bytecode=bytecode)
tx_hash = contract.constructor(...).transact()
```

**Benefits**:

- Faster deployments (no recompilation)
- Consistent artifacts across environments
- Easier debugging (bytecode matches verification)

## Bytecode Size Analysis

**Check Contract Sizes**:

```bash
# Show all contract sizes
for f in artifacts/bytecode/*.runtime.bin; do
    size=$(wc -c < "$f" | xargs)
    bytes=$((size / 2))
    echo "$(basename $f .runtime.bin): $bytes bytes"
done
```

**24KB Limit Check**:

```bash
# Contracts exceeding 24KB (24576 bytes)
for f in artifacts/bytecode/*.runtime.bin; do
    size=$(wc -c < "$f" | xargs)
    bytes=$((size / 2))
    if [ $bytes -gt 24576 ]; then
        echo "⚠️  $(basename $f .runtime.bin): $bytes bytes (EXCEEDS LIMIT)"
    fi
done
```

**Size Reduction Strategies**:

1. **Enable Via-IR**: `--via-ir` (often reduces 10-20%)
2. **Library Extraction**: Move reusable logic to libraries
3. **Function Modifiers**: Convert to internal functions
4. **Error Strings**: Use custom errors instead of `require` strings
5. **Proxy Pattern**: Deploy core logic separately

## Gas Analysis with Opcodes

**Count Expensive Opcodes**:

```bash
# Count SLOAD (200 gas each)
grep -o "SLOAD" artifacts/opcodes/FutarchyArbExecutorV5.opcodes | wc -l

# Count SSTORE (20000 gas for new slot)
grep -o "SSTORE" artifacts/opcodes/FutarchyArbExecutorV5.opcodes | wc -l

# Count external calls
grep -o "CALL\|STATICCALL\|DELEGATECALL" artifacts/opcodes/FutarchyArbExecutorV5.opcodes | wc -l
```

**Optimization Opportunities**:

- Multiple `SLOAD` of same slot → Cache in memory
- `SSTORE` in loops → Batch updates
- `CALL` in loops → Use multicall pattern

## Security Audit with Opcodes

**Check for Dangerous Operations**:

```bash
# SELFDESTRUCT (contract can be destroyed)
grep "SELFDESTRUCT" artifacts/opcodes/*.opcodes

# DELEGATECALL (executes external code in our context)
grep "DELEGATECALL" artifacts/opcodes/*.opcodes

# CREATE2 (deterministic address deployment)
grep "CREATE2" artifacts/opcodes/*.opcodes
```

**Expected Results**:

- `InstitutionalSolverCore`: No SELFDESTRUCT (good)
- `FutarchyArbExecutorV5`: DELEGATECALL to Balancer/Swapr (expected)
- `PectraWrapper`: CREATE2 for EIP-7702 delegation (expected)

## Troubleshooting

### Compilation Fails

```
Error: Source file requires different compiler version
```

**Solution**: Check Solidity pragma in contract:

```solidity
pragma solidity 0.8.33;  // Must match --solc-version
```

### Missing Artifacts

```
✗ ABI not generated
```

**Cause**: Contract has compilation errors

**Solution**: Check `stderr` output for syntax errors

### SMT Checker Timeout

```
Warning: SMT solver timeout
```

**Solution**: Reduce contract complexity or disable SMT:

```bash
python3 scripts/compile_all.py --contract SafetyModule  # No --smt
```

### Bytecode Too Large

```
Contract bytecode size: 26543 bytes (exceeds 24KB limit)
```

**Solution**:

1. Enable Via-IR: `--via-ir`
2. Extract libraries
3. Use proxy pattern

## References

- [Solidity Compiler Options](https://docs.soliditylang.org/en/latest/using-the-compiler.html)
- [EVM Opcodes](https://www.evm.codes/)
- [SMT Checker](https://docs.soliditylang.org/en/latest/smtchecker.html)
- [Storage Layout](https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html)

## Examples

### Compile All Contracts

```bash
./scripts/compile.sh
```

### Compile V5 Executor with Verification

```bash
python3 scripts/compile_all.py --contract FutarchyArbExecutorV5 --smt
```

### Compile Institutional Solver (Large Contract)

```bash
python3 scripts/compile_all.py --contract InstitutionalSolverCore --via-ir
```

### Check Contract Sizes

```bash
python3 scripts/compile_all.py
cat artifacts/compilation_summary.json | jq '.contracts[] | select(.bytecode_size > 24576)'
```

### Deploy with Pre-compiled Artifacts

```python
from pathlib import Path
import json

# Load artifacts
abi = json.loads(Path("artifacts/abi/FutarchyArbExecutorV5.json").read_text())
bytecode = Path("artifacts/bytecode/FutarchyArbExecutorV5.hex").read_text().strip()

# Deploy
contract = web3.eth.contract(abi=abi, bytecode=bytecode)
tx = contract.constructor(router, balancer, swapr).build_transaction({
    'from': deployer,
    'gas': 5000000,
    'maxFeePerGas': web3.to_wei(50, 'gwei'),
    'maxPriorityFeePerGas': web3.to_wei(2, 'gwei'),
})
signed = web3.eth.account.sign_transaction(tx, private_key)
tx_hash = web3.eth.send_raw_transaction(signed.raw_transaction)
```

## Best Practices

1. **Always Compile Before Deploy**: Run `./scripts/compile.sh` to ensure artifacts are up-to-date
2. **Check Bytecode Size**: Verify contracts are under 24KB limit
3. **Use SMT for Critical Contracts**: Enable `--smt` for SafetyModule, executors
4. **Version Control Artifacts**: Commit `artifacts/` to track bytecode changes
5. **Automate in CI**: Add compilation step to GitHub Actions
6. **Compare Deployments**: Diff bytecode against on-chain code to verify matches

## CI/CD Integration

**GitHub Actions Workflow**:

```yaml
name: Compile Contracts

on: [push, pull_request]

jobs:
  compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive # For lib/solady

      - name: Install Solidity
        run: |
          sudo add-apt-repository ppa:ethereum/ethereum
          sudo apt-get update
          sudo apt-get install solc

      - name: Compile Contracts
        run: ./scripts/compile.sh

      - name: Check Contract Sizes
        run: |
          python3 -c "import json; data = json.load(open('artifacts/compilation_summary.json')); print('Large contracts:', [k for k,v in data['contracts'].items() if v.get('bytecode_size', 0) > 24576])"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: compilation-artifacts
          path: artifacts/
```
